services:
  kafka-broker:
    image: apache/kafka:latest
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka-broker:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka-broker:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_NUM_PARTITIONS=2
    volumes:
      - kafka_data:/bitnami/kafka
    networks:
      - agrotrace-network
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/9092' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  kafka-dashboard:
    image: provectuslabs/kafka-ui:latest
    ports:
      - "8081:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=agrotrace-kafka
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka-broker:9092
    depends_on:
      - kafka-broker
    networks:
      - agrotrace-network

  simulateur-capteurs:
    build: ./0-Simulateur-Capteurs
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-broker:9092
      - KAFKA_TOPIC=sensor-data
      - SEND_INTERVAL=2
    depends_on:
      kafka-broker:
        condition: service_healthy
    networks:
      - agrotrace-network
    volumes:
      - ./0-Simulateur-Capteurs/Dataset:/app/Dataset

  timescaledb:
    image: timescale/timescaledb:latest-pg16
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=agrotrace
      - POSTGRES_USER=agrotrace_user
      - POSTGRES_PASSWORD=agrotrace_pass
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
      - ./1-IngestionCapteurs/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql
    networks:
      - agrotrace-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agrotrace_user -d agrotrace"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - agrotrace-network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  ingestion-capteurs:
    build: ./1-IngestionCapteurs
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-broker:9092
      - KAFKA_TOPIC=sensor-data
      - KAFKA_GROUP_ID=ingestion-group
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=agrotrace
      - DB_USER=agrotrace_user
      - DB_PASSWORD=agrotrace_pass
    depends_on:
      kafka-broker:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
    networks:
      - agrotrace-network

  preprocessing:
    build: ./2-Pretraitement
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-broker:9092
      - KAFKA_INPUT_TOPIC=sensor-data
      - KAFKA_OUTPUT_TOPIC=sensor-data-processed
      - KAFKA_GROUP_ID=preprocessing-group
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=agrotrace
      - DB_USER=agrotrace_user
      - DB_PASSWORD=agrotrace_pass
      - ANOMALY_THRESHOLD=3.0
      - MOVING_AVERAGE_WINDOW=5
    depends_on:
      kafka-broker:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
      ingestion-capteurs:
        condition: service_started
    networks:
      - agrotrace-network

  vision-plante:
    build: ./3-VisionPlante
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-broker:9092
      - KAFKA_IMAGE_TOPIC=image.uploaded
      - KAFKA_DISEASE_TOPIC=disease.detected
      - KAFKA_GROUP_ID=vision-plante-group
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_SECURE=False
      - MINIO_RAW_BUCKET=raw-uav-images
      - MINIO_RESULTS_BUCKET=disease-detection-results
      - MODEL_NAME=Abuzaid01/plant-disease-classifier
      - MODEL_DEVICE=cpu
      - CONFIDENCE_THRESHOLD=0.5
      - BATCH_SIZE=1
      - IMAGE_FOLDER_PREFIX=mixed_images/
      - AUTO_PUBLISH_ON_STARTUP=True
    depends_on:
      kafka-broker:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - agrotrace-network

  prevision-eau:
    build: ./4-PrévisionEau
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-broker:9092
      - KAFKA_SENSOR_TOPIC=sensor-data-processed
      - KAFKA_FORECAST_TOPIC=water.forecast
      - KAFKA_GROUP_ID=water-forecast-group
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=agrotrace
      - DB_USER=agrotrace_user
      - DB_PASSWORD=agrotrace_pass
      - FORECAST_HORIZON=7
      - TRAINING_WINDOW_DAYS=30
      - MIN_DATA_POINTS=10
      - RETRAINING_INTERVAL_HOURS=6
      - PUBLISH_INTERVAL_MINUTES=60
      - WATER_STRESS_THRESHOLD_LOW=30.0
      - WATER_STRESS_THRESHOLD_MEDIUM=50.0
      - WATER_STRESS_THRESHOLD_HIGH=70.0
    depends_on:
      kafka-broker:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
      preprocessing:
        condition: service_started
    networks:
      - agrotrace-network

  regles-agro:
    build: ./5-RèglesAgro
    container_name: regles-agro
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-broker:9092
      - KAFKA_TOPIC_WATER_FORECAST=water.forecast
      - KAFKA_TOPIC_DISEASE_DETECTED=disease.detected
      - KAFKA_TOPIC_SENSOR_DATA=sensor-data-processed
      - KAFKA_TOPIC_RECOMMENDATIONS=agro.recommendations
      - KAFKA_GROUP_ID=regles-agro-group
      - LOG_LEVEL=INFO
    depends_on:
      kafka-broker:
        condition: service_healthy
      prevision-eau:
        condition: service_started
      vision-plante:
        condition: service_started
    networks:
      - agrotrace-network

  postgres-irrigation:
    image: postgres:16-alpine
    container_name: postgres-irrigation
    ports:
      - "5434:5432"
    environment:
      - POSTGRES_DB=irrigation
      - POSTGRES_USER=irrigation_user
      - POSTGRES_PASSWORD=irrigation_pass
    volumes:
      - postgres_irrigation_data:/var/lib/postgresql/data
      - ./6-RecoIrrigation/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - agrotrace-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U irrigation_user -d irrigation"]
      interval: 10s
      timeout: 5s
      retries: 5

  reco-irrigation:
    build: ./6-RecoIrrigation
    container_name: reco-irrigation
    ports:
      - "8086:8086"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8086
      - KAFKA_BOOTSTRAP_SERVERS=kafka-broker:9092
      - KAFKA_TOPIC_RECOMMENDATIONS=agro.recommendations
      - KAFKA_GROUP_ID=reco-irrigation-group
      - POSTGRES_HOST=postgres-irrigation
      - POSTGRES_PORT=5432
      - POSTGRES_DB=irrigation
      - POSTGRES_USER=irrigation_user
      - POSTGRES_PASSWORD=irrigation_pass
      - LOG_LEVEL=INFO
    depends_on:
      kafka-broker:
        condition: service_healthy
      postgres-irrigation:
        condition: service_healthy
      regles-agro:
        condition: service_started
    networks:
      - agrotrace-network

  # ==================== MS7: DASHBOARD SIG ====================
  
  # PostGIS Database for spatial data
  postgis:
    image: postgis/postgis:16-3.4-alpine
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=agrotrace_sig
      - POSTGRES_USER=agrotrace_user
      - POSTGRES_PASSWORD=agrotrace_pass
    volumes:
      - postgis_data:/var/lib/postgresql/data
    networks:
      - agrotrace-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agrotrace_user -d agrotrace_sig"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Dashboard Backend API (FastAPI)
  dashboard-backend:
    build: ./7-DashboardSIG/backend
    ports:
      - "8085:8085"
    environment:
      - POSTGIS_HOST=postgis
      - POSTGIS_PORT=5432
      - POSTGIS_DB=agrotrace_sig
      - POSTGIS_USER=agrotrace_user
      - POSTGIS_PASSWORD=agrotrace_pass
      - KAFKA_BOOTSTRAP_SERVERS=kafka-broker:9092
      - KAFKA_GROUP_ID=dashboard-sig-group
      - API_HOST=0.0.0.0
      - API_PORT=8085
    depends_on:
      kafka-broker:
        condition: service_healthy
      postgis:
        condition: service_healthy
    networks:
      - agrotrace-network

  # Dashboard Frontend (React + Leaflet)
  dashboard-frontend:
    build: ./7-DashboardSIG/frontend
    ports:
      - "3000:80"
    depends_on:
      - dashboard-backend
    networks:
      - agrotrace-network

  # ==================== SONARQUBE ====================
  
  # PostgreSQL Database for SonarQube
  sonarqube-db:
    image: postgres:16-alpine
    container_name: sonarqube-db
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
      - POSTGRES_DB=sonarqube
    volumes:
      - sonarqube_db_data:/var/lib/postgresql/data
    networks:
      - agrotrace-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sonar -d sonarqube"]
      interval: 10s
      timeout: 5s
      retries: 5

  # SonarQube Server
  sonarqube:
    image: sonarqube:lts-community
    container_name: sonarqube
    ports:
      - "9090:9000"
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://sonarqube-db:5432/sonarqube
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=sonar
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    depends_on:
      sonarqube-db:
        condition: service_healthy
    networks:
      - agrotrace-network

  # Sonar Scanner CLI (run with: docker compose --profile scan run sonar-scanner)
  sonar-scanner:
    image: sonarsource/sonar-scanner-cli:latest
    container_name: sonar-scanner
    environment:
      - SONAR_HOST_URL=http://sonarqube:9000
    volumes:
      - .:/usr/src
    working_dir: /usr/src
    depends_on:
      - sonarqube
    networks:
      - agrotrace-network
    profiles:
      - scan

  # ==================== JENKINS CI/CD ====================
  
  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins
    privileged: true
    user: root
    ports:
      - "8080:8080"
      - "50000:50000"
    environment:
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_CERT_PATH=/certs/client
      - DOCKER_TLS_VERIFY=1
    volumes:
      - jenkins_home:/var/jenkins_home
      - jenkins_docker_certs:/certs/client:ro
    depends_on:
      - docker
    networks:
      - agrotrace-network

  docker:
    image: docker:dind
    container_name: jenkins-docker
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=/certs
    volumes:
      - jenkins_docker_certs:/certs/client
      - jenkins_home:/var/jenkins_home
    networks:
      - agrotrace-network

volumes:
  kafka_data:
  timescaledb_data:
  minio_data:
  postgres_irrigation_data:
  postgis_data:
  sonarqube_db_data:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  jenkins_home:
  jenkins_docker_certs:

networks:
  agrotrace-network:
